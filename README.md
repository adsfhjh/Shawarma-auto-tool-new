# Shawarma-auto-tool-new
# 半自动沙威玛辅助工具

Python 开发的快捷键实现自动鼠标控制沙威玛辅助工具。**有图像识别自动喂食客人，但喂食哪一位需要自己按快捷键**

图像识别功能：

- 识别客人气泡，判断需要喂哪些东西
- 识别桌子上的沙威玛，自动拿取。不会凭空点击桌子上的错误位置。
- 识别桌子右侧的薯条位置。

## 0. 我的沙威玛游戏

名为“Shawarma Legend”的是沙威玛游戏快捷方式。同名文件夹则为游戏的根目录。如果你没有购买steam版本的沙威玛传奇，可以尝试这个。安全无毒。

## 1. 快速开始

### 1.1 配置 python 环境，安装依赖库。

依赖库：

- `pyperclip` 用于快速复制当前鼠标坐标
- `win32api, win32con` 模拟鼠标操作
- `pynput` 监听键盘，绑定快捷键
- `mss` 屏幕截图
- `opencv-python` 图像识别
- `rich` 彩色控制台输出

安装方法： `pip install pyperclip pywin32 pynput mss opencv-python rich`

运行方法：在项目目录下，打开终端，运行 `python main.py`

按下 Esc 键退出，如需临时切出游戏画面，可按 Windows 键。

### 1.2 检查分辨率

如果你的显示器是 1920x1080 分辨率，100%缩放。并且现在顾客是 4 个，那全屏运行游戏，看看按下 q、w、a、1、2、3、4 键是否能正常工作。
能的话，后面不用看了，这就是脚本的所有功能。

按下 q、w、a 鼠标应当能够正确移动到目标位置，拖动操作、点击均正常。

1、2、3、4 键应当能够正确识别客人的气泡，弹出的三个窗口中有正确识别客人需求，画框位置准确。


### 1.3 上述不满足/出现问题

**显示器不是 1920x1080**：需要重新配置坐标点，见下方 `2.1 坐标点`

**点击位置不对**：需要运行脚本，用快捷键 p 复制鼠标的坐标，并配置坐标点，见下方 `2.1 坐标点`

**鼠标点击了，位置正确，但游戏不响应**，见下方 `2.3 鼠标操作和延迟`

**弹出的三个窗口上，有没有正确画框**（识别）并自动投喂: 见下方 `2.2 图像识别`

**客人数量不是4个**，见结尾部分`3.3 自行定制开发` 和 `例：添加第五位客人的识别`。

## 2 配置

> tips: 你可以编辑 `main.py` 中399到401行的内容，来修改按下什么按键可以让脚本退出：

```python
# main.py

async def handle_key_press(key):
    # 这一行表示按下 esc 键退出
    if key in {keyboard.Key.esc}:
    # 你可以自己添加其他按键，比如按下 ESC 或 f1 键退出
    if key in {keyboard.Key.esc, keyboard.Key.f1}:
```

**只要配置好了坐标点，就可以运行不需要视觉识别的部分了**（如一键添加4个菜制作沙威玛）。

---

启动脚本后，会弹出三个灰色窗口，分别是截取客人气泡、截取桌子上的沙威玛、截取桌子右侧的薯条。
这三个窗口是用来调试图像识别的，不影响脚本的运行。可以实时观看识别效果。

> 注意只有按了快捷键后才会识别，不会一直识别。薯条也是只有发现客人要薯条，才会去桌子右侧识别

根目录 `config.py` 内有部分杂项配置（就两条），此文件被导入 `main.py` 内。如果你的沙威玛进度接近满级，这个可以不用管。

在 `sha` 目录下：

- `__init__.py`：实现鼠标控制的抽象层。在这里可以微调鼠标的移动延迟，下文有说。
- `points.py`：配置坐标点，内部包含详细注释。
- `cv.py`：实现图像识别功能，内部指定了读取哪些png文件。

### 2.1 🔨坐标点(sha/points.py)

坐标点在 `sha/points.py` 内配置，对应文件内有详细注释。可以使用快捷键 p 复制当前鼠标坐标，然后粘贴到对应的位置。

配置好坐标后，以下功能可以使用：
- 一键添加四个菜并卷饼，制备沙威玛（快捷键 q）
- 一键点击炸土豆，把炸好的土豆放到盘子上（快捷键 w，解锁了自动炸土豆则无需此步骤）
- 一键进货（快捷键 a）

### 2.2 🖼️图像识别(sha/cv.py)

> test/ 文件夹下的图片是用来测试的，在我的环境下，这几张图片是能被正确识别的。你可以看下方说明，拉取项目后，立即运行 `python test.py` 测试图像匹配。这一步能够确保图片截取都是正确的。
> 
> 也可以备份这些图片后，替换成自己的图片，测试图像匹配在自己的屏幕截图下是否正确工作。**如果没有修改 test 下的图片，且这部分测试无法正确画框，那就是出 bug 了，我还没有复现这种情况**
> 
> 你也可以自行修改 test.py 内的代码，来测试不同的图像识别逻辑。核心就是测试 `cv.match_many_object_on_image` 函数。

图像识别在 `sha/cv.py` 内。推荐先运行脚本，按下快捷键 1、2、3、4（不是小键盘上的）喂食客人
（等着客人来了并且出现气泡），看看是否正常识别。

**如果窗口范围不正确**：重新改 `sha/points.py` 内的坐标点，确保截取的区域完全包含客人气泡即可。

**如果范围正确，但不识别、不画框**：运行 `python test.py`，然后进入 `test` 文件夹，查看所有以 `__test` 名字开头的图片，看看是否有正确画框。

## 3 例子

### 例：添加第五位客人的识别

目前脚本识别的是4位客人，如果要添加第5位客人的识别，可以这样做：

更新坐标点。运行脚本，打开游戏，需要采集的点是：五位客人的中心坐标、五个客人气泡的左上角坐标、五个客人气泡的右下角坐标。更新到 `sha/points.py` 内。

你可以仿照脚本里的写法，加入类似这样的：

```python
# sha/points.py

POS_GUEST_5 = (xxx, xxx)

POS_GUEST_5_LT = (xxx, xxx)
POS_GUEST_5_RB = (xxx, xxx)
```

> 如果前面的客人位置也改变了，那么同理需要修改 sha/points.py 内其他客人的坐标。

喂食用了一个函数 `feed_guest_image_recognition`，我们将在快捷键部分调用这个函数。

> 还有一个 `__feed_guest_image_recognition` 函数，这是最终会被放到线程池上执行的回调函数，内部实现了喂食的具体逻辑，目前我们无需直接与它打交道。

上述函数接受三个参数：**(客人气泡左上角点, 客人气泡右下角点, 客人中心点)** 传错顺序会导致图像识别不工作，且没有报错信息。


接着绑定快捷键，修改 `main.py` 内的 `handle_key_press` 函数，添加一个新的 if 分支，比如：

```python
# main.py 369
# 原有
async def handle_key_press(key):
    # ...
    try:
        if key.char == 'p':
            ...
        # 原有
        elif key.char == '4':
            # feed_guest(POS_GUEST_4)
            feed_guest_image_recognition(POS_GUEST_4_LT, POS_GUEST_4_RB, POS_GUEST_4)

        # 追加
        elif key.char == '5':
			feed_guest_image_recognition(POS_GUEST_5_LT, POS_GUEST_5_RB, POS_GUEST_5)
    # ...
```

现在去游戏内，按下 5 键，应该可以识别第五位客人的需求，并自动喂食了。

